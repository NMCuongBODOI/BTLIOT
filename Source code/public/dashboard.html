<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>AI Robot Controller</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --dark-bg: #0f0f1e;
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --text-light: #ecf0f1;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            user-select: none;
            touch-action: manipulation;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        h3 { 
            margin: 0; 
            font-size: 22px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase; 
            letter-spacing: 2px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 i {
            font-size: 26px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: robotPulse 2s ease-in-out infinite;
        }

        @keyframes robotPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .header-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-admin {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        #btn-logout {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-light);
            border: 2px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #btn-logout:hover { 
            background: rgba(244, 67, 54, 0.2);
            border-color: var(--danger-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #cam-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            border: 3px solid var(--border-color);
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        img#cam-view { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }

        .control-panel {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-panel {
            font-size: 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 15px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
        }
        .info-panel i {
            color: var(--success-color);
            font-size: 18px;
        }
        #dist { 
            color: var(--success-color); 
            font-weight: bold; 
            font-family: 'Courier New', monospace; 
            font-size: 20px;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .btn-func {
            padding: 14px 20px;
            font-size: 15px;
            border-radius: 15px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            width: 100%;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            color: #000;
        }

        .btn-func i {
            margin-right: 8px;
            color: #000;
        }

        #btn-auto { 
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.3), rgba(192, 57, 43, 0.3)); 
            color: white; 
            border-color: #e74c3c;
        }
        #btn-auto:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        .auto-on { 
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.3), rgba(34, 153, 84, 0.3)) !important; 
            color: white;
            border-color: var(--success-color) !important;
            animation: pulseGlow 1.5s infinite;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 70px);
            gap: 10px;
            margin-top: 10px;
        }

        .btn-move {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid var(--border-color);
            border-radius: 15px;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn-move::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn-move:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .btn-move:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.6);
            background: var(--primary-gradient);
        }

        .btn-move:active::before {
            width: 200%;
            height: 200%;
        }

        .btn-stop { 
            background: linear-gradient(135deg, rgba(149, 165, 166, 0.3), rgba(127, 140, 141, 0.3));
            font-size: 14px; 
            font-weight: bold;
            border-color: #95a5a6;
        }
        .btn-stop:active { 
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
        }

        .alert-history-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .alert-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .alert-table th {
            background: var(--primary-gradient);
            color: white;
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
        }

        .alert-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-light);
        }

        .alert-table tbody tr {
            transition: all 0.3s;
        }

        .alert-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
            text-transform: uppercase;
        }

        .badge-climbing {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
        }

        .badge-fall {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
        }

        .alert-table img {
            transition: transform 0.3s;
        }

        .alert-table img:hover {
            transform: scale(1.5);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            }
            50% { 
                box-shadow: 0 4px 25px rgba(39, 174, 96, 0.8), 0 0 20px rgba(39, 174, 96, 0.5);
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 420px) {
            .control-grid { 
                grid-template-rows: repeat(2, 60px); 
                gap: 8px; 
            }
            .btn-move { 
                font-size: 24px; 
            }
            h3 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h3>
            <i class="fas fa-robot"></i>
            ROBOT CONTROL CENTER
        </h3>
        <div class="header-buttons">
            <button class="btn-admin" id="adminBtn" onclick="window.location.href='/admin.html'" style="display:none;">
                <i class="fas fa-cog"></i> Admin
            </button>
            <button id="btn-logout" title="ƒêƒÉng xu·∫•t" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                ƒêƒÉng xu·∫•t
            </button>
        </div>
    </header>

    <div class="main-content">
        <!-- Video Section (Left - Larger) -->
        <div class="video-section">
            <div class="section-title">
                <i class="fas fa-video"></i>
                Camera Tr·ª±c ti·∫øp
            </div>
            <div id="cam-container">
                <img id="cam-view" src="" alt="ƒêang ch·ªù k·∫øt n·ªëi Camera...">
            </div>
        </div>

        <!-- Control Panel (Right) -->
        <div class="control-panel">
            <div class="section-title">
                <i class="fas fa-gamepad"></i>
                ƒêi·ªÅu khi·ªÉn
            </div>

            <div class="info-panel">
                <i class="fas fa-ruler"></i>
                Kho·∫£ng c√°ch: <span id="dist">--</span> cm
            </div>

            <button id="btn-auto" class="btn-func" onclick="toggleAuto()">
                <i class="fas fa-robot"></i> AUTO: T·∫ÆT
            </button>

            <div class="control-grid">
                <div></div>
                <button class="btn-move"
                        onmousedown="sendMove('forward')"
                        ontouchstart="sendMove('forward')">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <div></div>

                <button class="btn-move"
                        onmousedown="sendMove('right')" onmouseup="sendMove('stop')"
                        ontouchstart="sendMove('right')" ontouchend="sendMove('stop')">
                    <i class="fas fa-arrow-left"></i>
                </button>

                <button class="btn-move btn-stop" onclick="sendMove('stop')">
                    <i class="fas fa-stop"></i>
                </button>

                <button class="btn-move"
                        onmousedown="sendMove('left')" onmouseup="sendMove('stop')"
                        ontouchstart="sendMove('left')" ontouchend="sendMove('stop')">
                    <i class="fas fa-arrow-right"></i>
                </button>

            </div>

            <div style="margin-top: 0px; display: flex; justify-content: center;height: 70px;">
                <button class="btn-move" style="width: 150px;"
                        onmousedown="sendMove('backward')" onmouseup="sendMove('stop')"
                        ontouchstart="sendMove('backward')" ontouchend="sendMove('stop')">
                    <i class="fas fa-arrow-down"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Alert History Section -->
    <div class="alert-history-section">
        <div class="section-title">
            <i class="fas fa-bell"></i>
            L·ªãch s·ª≠ C·∫£nh b√°o AI
            <button class="btn-func" onclick="loadAlerts()" style="margin-left: auto; padding: 8px 16px; width: auto;">
                <i class="fas fa-sync-alt"></i> L√†m m·ªõi
            </button>
        </div>
        <table class="alert-table">
            <thead>
                <tr>
                    <th>Th·ªùi gian</th>
                    <th>Lo·∫°i s·ª± ki·ªán</th>
                    <th>ƒê·ªô tin c·∫≠y</th>
                    <th>H√¨nh ·∫£nh</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
            </thead>
            <tbody id="alertTableBody">
                <tr>
                    <td colspan="5" style="text-align: center; padding: 30px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; opacity: 0.5;"></i>
                        <p style="margin-top: 10px; opacity: 0.5;">ƒêang t·∫£i...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const WS_URL = 'ws://' + window.location.hostname + ':3000';
    let ws;
    let isAuto = false;
    let lastCmd = "";

    function connect() {
        ws = new WebSocket(WS_URL);
        ws.binaryType = 'blob';

        ws.onopen = () => {
            console.log("ƒê√£ k·∫øt n·ªëi t·ªõi Server!");
            ws.send(JSON.stringify({type: 'register', role: 'user'}));
            document.getElementById('dist').innerText = "Ready";
        };

        ws.onmessage = (event) => {
            if (event.data instanceof Blob) {
                // hi·ªÉn th·ªã ·∫£nh t·ª´ blob
                const url = URL.createObjectURL(event.data);
                const img = document.getElementById('cam-view');
                img.onload = () => URL.revokeObjectURL(img.src);
                img.src = url;
                return;
            }
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'sensor' && data.distance !== undefined) {
                    document.getElementById('dist').innerText = data.distance;
                }
                else if (data.type === 'alert') {
                    // Realtime alert t·ª´ AI
                    if (navigator.vibrate) navigator.vibrate(200);
                    console.warn("üö® C·∫£nh b√°o AI:", data);
                    
                    // Hi·ªÉn th·ªã popup ho·∫∑c notification (optional)
                    showAlertNotification(data);
                    
                    // Reload alerts ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£ng
                    loadAlerts();
                }
            } catch(e) {
                // kh√¥ng ph·∫£i JSON -> b·ªè qua
            }
        };

        ws.onclose = () => {
            console.log("M·∫•t k·∫øt n·ªëi. ƒêang th·ª≠ l·∫°i...");
            document.getElementById('dist').innerText = "Offline";
            // t·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i
            setTimeout(() => {
                // n·∫øu ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng xu·∫•t (chuy·ªÉn trang) th√¨ kh√¥ng th·ª≠ l·∫°i
                if (window.location.pathname.endsWith('login.html')) return;
                connect();
            }, 2000);
        };

        ws.onerror = (err) => {
            console.error("WebSocket error:", err);
        };
    }

    function sendMove(val) {
        if (isAuto && val !== 'stop') return;

        if (val === 'stop') lastCmd = "";
        else if (val === lastCmd) return; // ch·ªëng spam l·ªánh tr√πng

        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({type: 'control', cmd: 'move', val: val}));
            if (val !== 'stop') lastCmd = val;
        }
    }

    function toggleAuto() {
        isAuto = !isAuto;
        const btn = document.getElementById('btn-auto');
        const cmdVal = isAuto ? 'auto_on' : 'auto_off';

        if (isAuto) {
            btn.innerHTML = '<i class="fas fa-robot"></i> AUTO: B·∫¨T';
            btn.classList.add('auto-on');
        } else {
            btn.innerHTML = '<i class="fas fa-robot"></i> AUTO: T·∫ÆT';
            btn.classList.remove('auto-on');
            sendMove('stop');
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({type: 'control', cmd: 'mode', val: cmdVal}));
        }
    }

    // Load alerts from API
    async function loadAlerts() {
        try {
            const response = await fetch('/api/alerts?limit=20');
            const data = await response.json();
            
            if (data.success) {
                const tbody = document.getElementById('alertTableBody');
                
                if (data.alerts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">
                                <i class="fas fa-inbox" style="font-size: 32px; opacity: 0.3;"></i>
                                <p style="margin-top: 10px; opacity: 0.5;">Ch∆∞a c√≥ c·∫£nh b√°o n√†o</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = data.alerts.map(alert => {
                    const alertTypes = {
                        'climbing': { text: 'Leo t∆∞·ªùng', class: 'badge-climbing', icon: 'fa-person-climbing' },
                        'fall': { text: 'B·ªã ng√£', class: 'badge-fall', icon: 'fa-person-falling' },
                        'suspicious': { text: 'Kh·∫£ nghi', class: 'badge-fall', icon: 'fa-exclamation-triangle' },
                        'intrusion': { text: 'X√¢m nh·∫≠p', class: 'badge-fall', icon: 'fa-user-secret' },
                        'running': { text: 'Ch·∫°y nhanh', class: 'badge-climbing', icon: 'fa-person-running' }
                    };
                    
                    const alertInfo = alertTypes[alert.type] || { text: alert.type, class: 'badge-climbing', icon: 'fa-bell' };
                    const timestamp = new Date(alert.timestamp).toLocaleString('vi-VN');
                    
                    return `
                        <tr>
                            <td>${timestamp}</td>
                            <td>
                                <span class="badge ${alertInfo.class}">
                                    <i class="fas ${alertInfo.icon}"></i> ${alertInfo.text}
                                </span>
                            </td>
                            <td><strong>${alert.confidence}%</strong></td>
                            <td>
                                ${alert.imageUrl ? `<img src="${alert.imageUrl}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 5px; cursor: pointer;" onclick="showAlertImage('${alert.imageUrl}')" />` : '-'}
                            </td>
                            <td>
                                ${alert.acknowledged 
                                    ? '<span style="color: var(--success-color);"><i class="fas fa-check-circle"></i> ƒê√£ x√°c nh·∫≠n</span>' 
                                    : `<button class="btn-func" style="padding: 6px 12px; font-size: 12px; width: auto; background: var(--warning-color); border-color: var(--warning-color);" onclick="acknowledgeAlert('${alert._id}')">
                                        <i class="fas fa-check"></i> X√°c nh·∫≠n
                                    </button>`}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Load alerts error:', error);
            document.getElementById('alertTableBody').innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 30px; color: var(--danger-color);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i>
                        <p style="margin-top: 10px;">L·ªói t·∫£i c·∫£nh b√°o</p>
                    </td>
                </tr>
            `;
        }
    }

    // Show alert notification (simple toast)
    function showAlertNotification(alert) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.5);
            z-index: 10000;
            animation: slideInRight 0.5s;
            max-width: 300px;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px;"></i>
                <div>
                    <strong>C·∫£nh b√°o AI!</strong>
                    <p style="margin: 5px 0 0; font-size: 13px;">${alert.message || 'Ph√°t hi·ªán s·ª± ki·ªán'}</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.5s';
            setTimeout(() => notification.remove(), 500);
        }, 5000);
    }

    // Show alert image in modal (simple version)
    function showAlertImage(imageUrl) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            cursor: pointer;
        `;
        
        modal.innerHTML = `
            <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; border-radius: 10px; box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);" />
        `;
        
        modal.onclick = () => modal.remove();
        document.body.appendChild(modal);
    }

    // Acknowledge alert
    async function acknowledgeAlert(alertId) {
        try {
            const response = await fetch(`/api/alerts/${alertId}/acknowledge`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show success message
                showAlertNotification({
                    message: 'ƒê√£ x√°c nh·∫≠n c·∫£nh b√°o th√†nh c√¥ng!'
                });
                
                // Reload alerts table
                loadAlerts();
            } else {
                alert('L·ªói: ' + data.message);
            }
        } catch (error) {
            console.error('Acknowledge alert error:', error);
            alert('L·ªói khi x√°c nh·∫≠n c·∫£nh b√°o');
        }
    }

    // Check if user is admin and show admin button
    async function checkUserRole() {
        try {
            const response = await fetch('/api/auth/me');
            const data = await response.json();
            
            if (data.success && data.user.role === 'admin') {
                document.getElementById('adminBtn').style.display = 'flex';
            }
        } catch (error) {
            console.error('Error checking user role:', error);
        }
    }

    // ƒêƒÇNG XU·∫§T -> ƒë√≥ng WS v√† chuy·ªÉn h∆∞·ªõng ƒë·∫øn login.html
    function logout() {
        const doLogout = confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?');
        if (!doLogout) return;

        try {
            if (ws && ws.readyState === WebSocket.OPEN) {
                // t√πy ch·ªçn: b·∫°n c√≥ th·ªÉ g·ª≠i event logout t·ªõi server n·∫øu c·∫ßn
                try { ws.send(JSON.stringify({type: 'control', cmd: 'logout', val: 'user_logout'})); } catch(e){}
                ws.close(1000, 'User logout');
            }
        } catch(e){}

        // optional: clear sessionStorage/localStorage n·∫øu b·∫°n l∆∞u token
        try {
            sessionStorage.clear();
            localStorage.removeItem('authToken');
        } catch(e){}

        // Call logout API
        fetch('/api/auth/logout', { method: 'POST' })
            .then(() => window.location.href = '/login.html')
            .catch(() => window.location.href = '/login.html');
    }

    // ƒê√≥ng WS khi r·ªùi trang (gi√∫p server bi·∫øt client disconnect s·ªõm)
    window.addEventListener('beforeunload', () => {
        try { if (ws && ws.readyState === WebSocket.OPEN) ws.close(); } catch(e){}
    });

    window.onload = () => {
        connect();
        checkUserRole();
        loadAlerts(); // Load alerts from MongoDB when page loads
    };
    document.addEventListener('contextmenu', event => event.preventDefault());
    
    // Add animation keyframes
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
</script>
</body>
</html>